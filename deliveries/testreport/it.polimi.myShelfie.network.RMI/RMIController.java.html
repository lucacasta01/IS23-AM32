<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RMIController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">it.polimi.myShelfie.network.RMI</a> &gt; <span class="el_source">RMIController.java</span></div><h1>RMIController.java</h1><pre class="source lang-java linenums">package it.polimi.myShelfie.network.RMI;
import it.polimi.myShelfie.application.Server;
import it.polimi.myShelfie.network.ClientHandler;
import it.polimi.myShelfie.network.ping.ServerPingThread;
import it.polimi.myShelfie.utilities.Position;
import it.polimi.myShelfie.utilities.Settings;
import it.polimi.myShelfie.utilities.Utils;
import it.polimi.myShelfie.utilities.pojo.Action;

import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.UnicastRemoteObject;
import java.rmi.server.Unreferenced;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
public class RMIController extends UnicastRemoteObject implements RMIServer,Runnable, Unreferenced {
    private final Server server;

<span class="nc" id="L21">    public RMIController() throws RemoteException {</span>
<span class="nc" id="L22">        server = Server.getInstance();</span>
<span class="nc" id="L23">    }</span>

    @Override
    public void run() {
        try {
<span class="nc" id="L28">            startServer();</span>
<span class="nc" id="L29">        } catch (RemoteException e) {</span>
<span class="nc" id="L30">            e.printStackTrace();</span>
<span class="nc" id="L31">        }</span>
<span class="nc" id="L32">    }</span>

    private void startServer() throws RemoteException {
<span class="nc" id="L35">        Registry registry = LocateRegistry.createRegistry(server.getRMIport());</span>

        try{
<span class="nc" id="L38">            registry.bind(Settings.RMINAME, this);</span>
<span class="nc" id="L39">        }catch(Exception e){</span>
<span class="nc" id="L40">            e.printStackTrace();</span>
<span class="nc" id="L41">        }</span>
<span class="nc" id="L42">        System.out.println(&quot;RMI server on&quot;);</span>
<span class="nc" id="L43">    }</span>

    @Override
    public void chatMessage(String username, String message) throws RemoteException {
<span class="nc" id="L47">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L48">                .keySet()</span>
<span class="nc" id="L49">                .stream()</span>
<span class="nc" id="L50">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L51">                .toList().get(0);</span>
<span class="nc" id="L52">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L53">            ch.setRmiAction(new Action(Action.ActionType.CHAT, username, message, null, null, null));</span>
<span class="nc" id="L54">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L55">        }</span>
<span class="nc" id="L56">    }</span>

    @Override
    public void privateMessage(String username, String message) throws RemoteException {
<span class="nc" id="L60">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L61">                .keySet()</span>
<span class="nc" id="L62">                .stream()</span>
<span class="nc" id="L63">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L64">                .toList().get(0);</span>
<span class="nc" id="L65">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L66">            ch.setRmiAction(new Action(Action.ActionType.PRIVATEMESSAGE, username, message, null, null, null));</span>
<span class="nc" id="L67">            ch.getRmiActions().notify();</span>
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">    }</span>

    @Override
    public void pickTiles(String username, List&lt;Position&gt; chosenTiles) throws RemoteException {
<span class="nc" id="L73">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L74">                .keySet()</span>
<span class="nc" id="L75">                .stream()</span>
<span class="nc" id="L76">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L77">                .toList().get(0);</span>
<span class="nc" id="L78">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L79">            ch.setRmiAction(new Action(Action.ActionType.PICKTILES, username, null, null, chosenTiles, null));</span>
<span class="nc" id="L80">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">    }</span>

    @Override
    public void selectColumn(String username, Integer column) throws RemoteException {
<span class="nc" id="L86">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L87">                .keySet()</span>
<span class="nc" id="L88">                .stream()</span>
<span class="nc" id="L89">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L90">                .toList().get(0);</span>

<span class="nc" id="L92">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L93">            ch.setRmiAction(new Action(Action.ActionType.SELECTCOLUMN, username, null, null, null, column));</span>
<span class="nc" id="L94">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L95">        }</span>
<span class="nc" id="L96">    }</span>

    @Override
    public void order(String username, String newOrder) throws RemoteException {
<span class="nc" id="L100">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L101">                .keySet()</span>
<span class="nc" id="L102">                .stream()</span>
<span class="nc" id="L103">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L104">                .toList().get(0);</span>

<span class="nc" id="L106">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L107">            ch.setRmiAction(new Action(Action.ActionType.ORDER, username, null, newOrder, null, null));</span>
<span class="nc" id="L108">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">    }</span>

    @Override
    public void lobbyKill(String username) throws RemoteException {
<span class="nc" id="L114">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L115">                .keySet()</span>
<span class="nc" id="L116">                .stream()</span>
<span class="nc" id="L117">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L118">                .toList().get(0);</span>


<span class="nc" id="L121">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L122">            ch.setRmiAction(new Action(Action.ActionType.LOBBYKILL, username, null, null, null, null));</span>
<span class="nc" id="L123">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L124">        }</span>
<span class="nc" id="L125">    }</span>

    @Override
    public void help(String username) throws RemoteException {
<span class="nc" id="L129">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L130">                .keySet()</span>
<span class="nc" id="L131">                .stream()</span>
<span class="nc" id="L132">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L133">                .toList().get(0);</span>

<span class="nc" id="L135">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L136">            ch.setRmiAction(new Action(Action.ActionType.HELP, username, null, null, null, null));</span>
<span class="nc" id="L137">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L138">        }</span>
<span class="nc" id="L139">    }</span>

    @Override
    public void infoMessage(String username, String message) throws RemoteException {
<span class="nc" id="L143">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L144">                .keySet()</span>
<span class="nc" id="L145">                .stream()</span>
<span class="nc" id="L146">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L147">                .toList().get(0);</span>

<span class="nc" id="L149">        synchronized (ch.getRmiActions()){</span>
<span class="nc" id="L150">            ch.setRmiAction(new Action(Action.ActionType.INFO, username, null, message, null, null));</span>
<span class="nc" id="L151">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L152">        }</span>
<span class="nc" id="L153">    }</span>

    @Override
    public void quit(String username) throws RemoteException {
<span class="nc" id="L157">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L158">                .keySet()</span>
<span class="nc" id="L159">                .stream()</span>
<span class="nc" id="L160">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L161">                .toList().get(0);</span>
            //todo chech quit from menu GUI (maybe works)
<span class="nc" id="L163">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L164">            ch.setRmiAction(new Action(Action.ActionType.QUIT, username, null, null, null, null));</span>
<span class="nc" id="L165">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L166">        }</span>
<span class="nc" id="L167">    }</span>

    @Override
    public void addClient(RMIClient client) throws RemoteException {
<span class="nc" id="L171">        ClientHandler clientHandler = new ClientHandler();</span>
<span class="nc" id="L172">        clientHandler.setRmiClient(client);</span>
<span class="nc" id="L173">        server.addRmiClientHandler(clientHandler);</span>
<span class="nc" id="L174">    }</span>

    @Override
    public boolean login(String username, RMIClient client) throws RemoteException {
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if(!Utils.checkNicknameFormat(username)){</span>
<span class="nc" id="L179">            return false;</span>
        }
        ClientHandler ch;
        Map&lt;ClientHandler, ServerPingThread&gt; myMap;
<span class="nc" id="L183">        synchronized (server.getConnectedClients()) {</span>
<span class="nc" id="L184">            myMap = new HashMap&lt;&gt;(server.getConnectedClients());</span>
<span class="nc" id="L185">        }</span>

<span class="nc" id="L187">        ch = myMap</span>
<span class="nc" id="L188">                .keySet()</span>
<span class="nc" id="L189">                .stream()</span>
<span class="nc" id="L190">                .filter(ClientHandler::isRMI)</span>
<span class="nc" id="L191">                .filter(c -&gt; c.getRmiClient().equals(client))</span>
<span class="nc" id="L192">                .toList()</span>
<span class="nc" id="L193">                .get(0);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">        if(server.isConnected(username)){</span>
<span class="nc" id="L195">            return false;</span>
        }
<span class="nc" id="L197">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L198">            ch.setRmiAction(new Action(Action.ActionType.INFO, username, null, username, null, null));</span>
<span class="nc" id="L199">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L200">        }</span>
<span class="nc" id="L201">        return true;</span>
    }

    @Override
    public void requestMenu(String username) throws RemoteException {
<span class="nc" id="L206">        ClientHandler ch = server.getConnectedClients()</span>
<span class="nc" id="L207">                .keySet()</span>
<span class="nc" id="L208">                .stream()</span>
<span class="nc" id="L209">                .filter(c -&gt; c.getNickname().equals(username))</span>
<span class="nc" id="L210">                .toList().get(0);</span>

<span class="nc" id="L212">        synchronized (ch.getRmiActions()) {</span>
<span class="nc" id="L213">            ch.setRmiAction(new Action(Action.ActionType.REQUEST_MENU, username, null, null, null, null));</span>
<span class="nc" id="L214">            ch.getRmiActions().notifyAll();</span>
<span class="nc" id="L215">        }</span>
<span class="nc" id="L216">    }</span>

    @Override
    public void ping() throws RemoteException {

<span class="nc" id="L221">    }</span>

    @Override
    public void unreferenced() {
<span class="nc" id="L225">        System.out.println(&quot;Client disconnesso!&quot;);</span>
<span class="nc" id="L226">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>